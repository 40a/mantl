[Unit]
Description=registrator
Documentation=https://github.com/progrium/registrator
After=docker.service
After=dnsmasq.service
After=consul.service
Requires=docker.service
Requires=consul.service
Requires=dnsmasq.service

[Service]
Restart=on-failure
RestartSec=20
TimeoutStartSec=0

ExecStartPre=-/usr/bin/docker pull {{ registrator_docker_image }}:{{ registrator_docker_tag }} 
ExecStart=/bin/bash -c \
    "/usr/bin/docker start -a {{ registrator_container_name }} || \
    /usr/bin/docker run \
        --name={{ registrator_container_name }} \
        --dns={{ ansible_eth0.ipv4.address }} \
        --privileged=true \
        -v /var/run/docker.sock:/tmp/docker.sock \
        -h {{ inventory_hostname }} \
        {{ registrator_docker_image }}:{{ registrator_docker_tag }} {{ registrator_consul_connect }}"

ExecStop=/usr/bin/docker kill {{ registrator_container_name }}

[Install]
WantedBy=multi-user.target
