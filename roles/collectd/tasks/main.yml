---
- name: install collectd
  sudo: yes
  yum:
    name: collectd
    state: present
  tags:
    - collectd
    - bootstrap

- name: create collectd plugin directory
  sudo: yes
  file:
    path: /usr/share/collectd/plugins
    state: directory
    mode: 0755
  tags:
  - collectd

- name: configure collectd
  sudo: yes
  template:
    src: collectd.conf.j2
    dest: /etc/collectd.conf
  notify:
    - restart collectd
  tags:
    - collectd

- name: check if collectd is authorized to make tcp connections
  sudo: yes
  shell: getsebool collectd_tcp_network_connect
  register: selinux_collectd_tcp_network_connect
  failed_when: no
  changed_when: no
  when: ansible_selinux.status == "enabled" and ansible_selinux.mode == "enforcing"
  tags:
    - collectd

- name: authorize collectd to make tcp connections
  sudo: yes
  shell: setsebool -P collectd_tcp_network_connect 1
  when: selinux_collectd_tcp_network_connect.stdout is defined and selinux_collectd_tcp_network_connect.stdout | match(".*off$")
  tags:
    - collectd

- name: enable collectd
  sudo: yes
  service:
    name: collectd
    enabled: yes
    state: started
  tags:
    - collectd


