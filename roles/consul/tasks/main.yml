---
- name: create directories
  sudo: true
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode | default(0750) }}"
  with_items:
    - path: /data
    - path: /data/ui
    - path: /etc/consul.d
  tags:
    - consul

- name: create TLS struture
  sudo: true
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode | default(0700) }}"
  with_items:
    - path: /etc/consul.d/ssl
  when: consul_enable_tls == true
  tags:
    - consul

- name: install unzip
  sudo: yes
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - unzip
  tags:
    - consul

- name: download consul
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: 0640
  with_items:
    - { 
        url: 'https://dl.bintray.com/mitchellh/consul/0.5.0_linux_amd64.zip',
        dest: '/tmp/consul.zip' 
      }
    - {
        url: 'https://dl.bintray.com/mitchellh/consul/0.5.0_web_ui.zip',
        dest: '/tmp/ui.zip'
      }
  tags:
    - consul

- name: unzip consul
  sudo: true
  unarchive:
    copy: false
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default(omit) }}"
  with_items:
    - {
        src: '/tmp/consul.zip',
        dest: '/bin',
        mode: '+x'
      }
    - {
        src: '/tmp/ui.zip',
        dest: '/data/ui'
      }
  tags:
    - consul

- name: copy tls files
  sudo: true
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0400
  with_items:
    - src: ca.cert
      dest: /etc/consul.d/ssl
    - src: consul.cert
      dest: /etc/consul.d/ssl
    - src: consul.key
      dest: /etc/consul.d/ssl
  when: consul_enable_tls == true
  tags:
    - consul

- name: configure consul
  sudo: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - src: consul.service.j2
      dest: /usr/lib/systemd/system/consul.service
    - src: consul.json.j2
      dest: /etc/consul.d/consul.json
  notify:
    - reload consul
  tags:
    - consul
