[Unit]
Description={{zookeeper_service}}
After=docker.service
Requires=docker.service
Requires=dnsmasq.service

[Service]
Restart=on-failure
RestartSec=20
TimeoutStartSec=20m

ExecStartPre=-/usr/bin/docker rm {{ zookeeper_container_name }}
ExecStartPre=-/usr/bin/docker pull {{ zookeeper_docker_image }}:{{ zookeeper_docker_tag }}
ExecStartPre=/bin/bash -c \
            '/usr/bin/docker inspect -f "\{\{.Created\}\}" {{ zookeeper_data_volume }} ||\
             /usr/bin/docker run --name={{ zookeeper_data_volume }} \
                                 -v /var/lib/zookeeper \
                                 -v /var/log/zookeeper \
                                 tianon/true' 

ExecStart=/usr/bin/docker run --name={{ zookeeper_container_name }} \
                              {{ zookeeper_docker_ports }} \
                              --dns={{ ansible_eth0.ipv4.address }} \
                              --dns-search=service.consul \
                              --env-file={{ zookeeper_docker_env }} \
                              --volumes-from {{ zookeeper_data_volume }} \
                              {{ zookeeper_docker_image }}:{{ zookeeper_docker_tag }}

ExecStop=/bin/bash -c \
         "/usr/bin/docker kill {{ zookeeper_container_name }} && \
          /usr/bin/docker rm {{ zookeeper_container_name }}"

[Install]
WantedBy=multi-user.target
